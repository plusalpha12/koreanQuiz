package server;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.SocketException;
import java.util.ArrayList;
import java.util.HashMap;

public class MainServer {

	private static InitialGameManager igm = null;
	private static HashMap<String, Client> map = null;
	private static ArrayList<Client> wuser = null;

	public static void main(String[] args) {

		igm = new InitialGameManager();
		map = new HashMap<String, Client>();
		wuser = new ArrayList<Client>();

		try(ServerSocket server = new ServerSocket(6060)) {
			while (true) {
				System.out.println("1 서버 준비");
				System.out.println("2 클라이언트 대기");
				Socket client = server.accept();
				System.out.println("3 클라이언트 연결");
				Server_thread ST = new Server_thread(client, igm, map, wuser);
				System.out.println("4 스레드 실행");
				ST.run();
			}
		} catch (IOException e) { e.printStackTrace(); }
	}
}

// 클라이언트 관리 스레드
class Server_thread extends Thread{

	private Socket soc = null;	// 클라이언트 소켓
	private InitialGameManager igm = null;
	private HashMap<String, Client> map = null;
	private ArrayList<Client> wuser = null;
	private Database db = null;

	private ObjectInputStream ois = null;
	private ObjectOutputStream oos = null;

	private ArrayList userdata = null;
	private UserDTO dto = null;
	private Client c = null;

	Server_thread(Socket soc, InitialGameManager igm, HashMap<String, Client> map, ArrayList<Client> wuser){
		this.soc = soc;
		this.igm = igm;
		this.map = map;
		this.wuser = wuser;
		oos = null;
		ois = null;
		dto = new UserDTO();
		db = new Database(dto);
		try{
			System.out.println("클라이언트 연결");
			ois = new ObjectInputStream(soc.getInputStream());
			oos = new ObjectOutputStream(soc.getOutputStream());
		}
		catch(SocketException | NullPointerException se){
			System.out.println("클라이언트 종료");
			try {soc.close();
			}catch (IOException e) {e.printStackTrace();}
		}
		catch (IOException e) {
			e.printStackTrace();
		}
	}

	public void run() {
		userdata = new ArrayList();


		while(true) {
			try {
				userdata = (ArrayList)ois.readObject();

				if(userdata.size() > 0) {

					if(userdata.get(0).equals("userjoin")) {
						userjoin();

					}else if(userdata.get(0).equals("userlogin")) {
						userlogin();

					}else if (userdata.get(0).equals("initial")) {
						wuser.add(c);
						System.out.println(wuser.get(0).getUserid() + wuser.get(0).getUsername());
						System.out.println("유저 대기");
						/*
						if((wuser.size() > 3 && wuser.size() <= 4) || Timeout()) {
							InitialGameRoom igroom = igm.createRoom(this, wuser);
							System.out.println("대기중인 클라이언트 입장");
							while(wuser != null) {
								receive_chat();
							}
						}
						*/

						//문장 맞추기
					}else if(userdata.get(0).equals("sentence")) {

					}else {
						/*
		    	           br = new BufferedReader(new InputStreamReader(soc.getInputStream()));	// 클라이언트로부터 데이터를 읽어올 준비를 합니다
		    	           pw = new PrintWriter(soc.getOutputStream());							// 클라이언트로 데이터를 보낼 준비를 합니다

		    	           String readData = "";

		    	           while(!(readData = br.readLine()).equals(null)){				//상대쪽에서 접속을 끊을때까지 기다립니다.
		    	                System.out.println("from Client > "+ readData);			//클라리언트가 보낸 메세지를 읽습니다.
		    	                pw.println(readData);									//읽은 메세지 그대로 클라이언트 한테 보냅니다.
		    	                pw.flush();												//프린트라이터 메모리를 초기화 시킵니다. 이 메소드가 행해져야 실질적으로 데이터가 전송됨
		    	                }
						 */
					}
				}
			} catch(ClassNotFoundException e){e.printStackTrace();}
			catch (IOException | NullPointerException e) {
				e.printStackTrace();
				System.out.println("클라이언트 종료");
				try {soc.close();
				} catch (IOException e1) {e1.printStackTrace();	}
			}
		}
	}

	public void userlogin() {

		String userid = new String(userdata.get(1).toString());
		String userpwd = new String(userdata.get(2).toString());

		try {
			if(db.IdCheck(userid)) {
				if(db.PwdCheck(userid, userpwd)) {
					System.out.println("승인");
					oos.writeObject("login");
					oos.flush();
					c = new Client(dto.getUserId(), dto.getUserName());
				}else {
					System.out.println("비밀번호");
					oos.writeObject("password");
					oos.flush();
				}
			}else {
				//아이디가 존재하지 않을 시
				System.out.println("아이디");
				oos.writeObject("id");
				oos.flush();
			}
		}catch(IOException e) {e.printStackTrace();}
	}

	public void userjoin() {
		String newuserid = new String(userdata.get(1).toString());
		String newuserpwd = new String(userdata.get(2).toString());
		String newusername = new String(userdata.get(3).toString());

		try {
			if(db.IdCheck(newuserid)) {
				System.out.println("이미 존재하는 아이디");
				oos.writeObject("dupid");
				oos.flush();
			}else if(db.nameCheck(newusername)) {
				System.out.println("이미 존재하는  닉네임");
				oos.writeObject("dupname");
				oos.flush();
			}else{
				db.Join_user(newuserid, newuserpwd, newusername);
				oos.writeObject("join");
				oos.flush();
			}
		}catch(IOException e) {e.printStackTrace();}
	}

	private boolean Timeout() {
		for(int i = 10; i > 0; i--) {
			try {
				Thread.sleep(1000);
				System.out.println(i);
			} catch (InterruptedException e) {
				e.printStackTrace();
			}
		}
		return true;
	}

	public void Send_userdata(Client c) {
		try {
			oos = new ObjectOutputStream(soc.getOutputStream());
			oos.writeObject(c);
			oos.flush();

		}catch(IOException e){
			e.printStackTrace();			
		}
	}

	public void receive_chat() {

		ArrayList textlist = new ArrayList();
		try {
			textlist = (ArrayList)ois.readObject();
		}
		catch (ClassNotFoundException e) {e.printStackTrace();}
		catch (IOException e) {e.printStackTrace();}
	}
}
